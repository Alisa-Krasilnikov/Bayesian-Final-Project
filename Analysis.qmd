---
title: "Bayesian Chi Squared Procedures"
author: "Alisa Krasilnikov, Harshini Karthikeyan"
format: html
embed-resources: true
editor: source
---

# References:

1.  Doing Bayesian data analysis:

-   Chapter 24 - Count Predicted Variables
-   Exercise 24.3

2.  https://www.flutterbys.com.au/stats/tut/tut11.2b.html

3.  https://www.kaggle.com/datasets/kritirathi/indian-food-dataset-with

## Data

```{r, message = FALSE, echo = TRUE}
#| label: load-packages
library(brms)
library(tidybayes)
library(dplyr)
library(broom)
```

Our dataset is the Indian food data set from Kaggle <https://www.kaggle.com/datasets/kritirathi/indian-food-dataset-with>. This is a set which pulls data from online Indian food recipes, and classifies them in various categories. We are particularly interested in whether there is a difference in flavor profile (spicy, sweet, and bitter) across diets (vegetarian and non-vegetarian).

```{r}
#| label: read-csv
indfood <- read.csv(here::here("Ifood_new.csv"))
```

```{r}
#| label: data-cleaning
indfood <- indfood |> 
  filter(flavor_profile != "-1",
         flavor_profile != "sour") |> #There is only one sour dish in the dataset
  mutate(dum_diet = if_else(diet == "vegetarian", 1, 0))

```

```{r}
#| label: summary
summary(indfood)
```

### Research Question:

**Is there a relationship between the flavor profile of Indian dishes and whether they are vegetarian or not?**

We will try to answer this question by modeling diet (vegetarian or non-vegetarian) as a function of flavor profile (sweet, spicy, or bitter), using Bayesian logistic regression.

### Weaknesses of the Data

There is complete separation of sweetness/bitterness and vegetarian, with all sweet or bitter foods in our data being vegetarian. Thus this dataset would be unable to be run with a frequentist approach, but choosing an adequate prior might allow for it to work with Bayesian statistics. Additionally, we dropped the flavor_profile sour as there is only one sour dish in the entire dataset.

```{r}
indfood |> group_by(diet) |> count(flavor_profile)

```

## Bayesian model

### Choosing Priors

Weâ€™ll assume the betas and sigma are independent. We believe that if a dish is sweet rather than bitter, then it will most likely be a vegetarian dish, since we couldn't think of many examples of desserts which were not vegetarian. Therefore, we specify an informative prior for the coefficient of the sweet flavor profile that reflects our belief that it increases the probability a dish is vegetarian (i.e., that it pushes the log-odds in a positive direction):

$\beta_{sweet}$ \~ N(0.75, 0.2)

This prior centers the log-odds increase at 0.75 (approximately corresponding to a 68% chance of being vegetarian, all else equal), while still allowing moderate uncertainty. For the other coefficients, we do not have strong prior opinions, and we allow brms to apply its default weakly informative priors.

**Prior predictive dist for sweet dish**

```{r}
n_rep = 10000

beta0 <- rnorm(n_rep, 0, 1)
beta_sweet <- rnorm(n_rep, 0.75, 0.2)

sweet <- sample(c(0, 1), n_rep, replace = TRUE)
log_odds <- beta0 + beta_sweet * sweet

p <- 1 / (1 + exp(-log_odds))

y_sim <- rbinom(n_rep, size = 1, prob = p)

hist(p,
     xlab = "Prior predicted P(Vegetarian) for sweet dish",
     breaks = 100,
     col = "pink",
     main = "Prior Predictive Distribution")
```

This isn't exactly what we want. The range is a little bit too big, but we like where it's centered. Let's adjust it a little bit so the effect of sweetness is a little bit stronger.

$\beta_{sweet}$ \~ N(1.75, 0.5)

```{r}
beta_0 <- rnorm(n_rep, 0, 1)
beta_sweet <- rnorm(n_rep, 1.75, 0.5)

log_odds <- beta0 + beta_sweet

p <- 1 / (1 + exp(-log_odds))

y_sim <- rbinom(n_rep, size = 1, prob = p)

hist(p,
     xlab = "Prior predicted P(Vegetarian) for sweet dish",
     breaks = 100,
     col = "pink",
     main = "Prior Predictive Distribution")
```

This looks a little better!

```{r}
n_rep = 1000

# x is binary: 0 (not sweet), 1 (sweet)
x <- sample(c(0, 1), n_rep, replace = TRUE)

# Priors for coefficients
beta0 <- rnorm(n_rep, 0, 1)           # intercept
beta1 <- rnorm(n_rep, 1.75, 0.5)      # effect for sweet = 1


# Compute probabilities for x = 0 and x = 1
p0 <- plogis(beta0 + beta1 * 0)  # bitter
p1 <- plogis(beta0 + beta1 * 1)  # sweet

# Plot histograms
hist(p0, breaks=100, col=rgb(0,0,1,0.4), xlim=c(0,1), ylim = c(0, 50),
     main="Prior Predictive Distribution of P(Vegetarian)",
     xlab="Probability", ylab="Frequency")
hist(p1, breaks=100, col=rgb(1,0,0,0.4), add=TRUE)
legend("topleft", legend=c("Bitter (Reference)", "Sweet"),
       fill=c(rgb(0,0,1,0.4), rgb(1,0,0,0.4)))

```

### Fitting with brms

```{r}
fit <- brm(
  data = indfood,
  family = bernoulli(link = "logit"),
  dum_diet ~ 1 + flavor_profile,
  prior = c(
    prior(normal(1.75, 0.5), class = "b", coef = "flavor_profilesweet")
    # No need to set priors for other coefficients, since we're happy with defaults
  ),
  iter = 4000,
  warmup = 1000,
  control = list(max_treedepth = 15),
  chains = 4,
  refresh = 0
)
```

```{r}
summary(fit) 
```

### Interpreting Intercepts

The intercept represents the log-odds of a dish being vegetarian when the flavor is bitter. All other coefficients are interpreted relative to this baseline.

The posterior mean for `sweet` is 1.73, telling us dishes with sweet flavor have odds of being vegetarian that are \~5.65 times higher (exp(1.73)) than bitter dishes

The posterior mean for `spicy`is -9.44, telling us dishes with sweet flavor have odds of being vegetarian that are \~7.948e-05 times less (exp(-9.44)) than bitter dishes

```{r}
exp(-9.44)
```

## Posterior Prediction

```{r}
indfood |>
  add_epred_draws(fit, ndraws = 500) |>
  group_by(flavor_profile) |>
  summarise(mean_pred = mean(.epred),
            .lower = quantile(.epred, 0.025),
            .upper = quantile(.epred, 0.975))


```

**Bitter:(0.933, 1.000)**

Based on the model and observed data, we are 95% confident that the true proportion of vegetarian dishes among bitter recipes lies between 93.3% and 100%. This indicates bitter dishes are very likely to be vegetarian, which follows our data set where all bitter dishes are vegetarian.

**Spicy: (0.742, 0.868)**

Based on the model and observed data, we are 95% confident that the true proportion of vegetarian dishes among spicy recipes lies between 74.2% and 86.8%. As our data has some of the spicy dishes as non-vegetarian this feels more accurate.

**Sweet: (0.988, 1.000)**

Based on the model and observed data, we are 95% confident that the true proportion of vegetarian dishes among sweet recipes lies between 98.8% and 100%. This supports our prior belief that sweet foods are almost always vegetarian.

```{r}
pp_check(fit, type = "bars")

```

## Frequentist Approach:

```{r}
# not sure we should do this but maybe?
table(indfood$flavor_profile, indfood$dum_diet) |> chisq.test()

```

A chi-squared test is inappropriate in this case due to the complete separation of sweetness and bitter that we mentioned previously. In this situation we would have expected cell counts of zero, violating assumptions of the chi-square test and resulting in inflated test statistics or errors.
